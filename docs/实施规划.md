---

  一、数据加载层优先级规则（固化）

  1.1 统一优先级策略

  原则：localStorage（用户导入） > public/data（静态默认） > fallback（空数据）

  修改文件：src/services/loaders.ts

  需要统一的加载函数

  // 1. loadActualsMonthly2025() - 第93-104行
  // 2. loadActualsMonthly2026() - 第75-88行
  // 3. loadActualsAnnual2025() - 新建

  实施策略

- ✅ 2025分月：localStorage → /data/actuals_monthly_2025.json → 空fallback
- ✅ 2026分月：localStorage → 空fallback（已实现）
- ✅ 2025年度：localStorage → /data/actuals_annual_2025.json + 兼容读取 /data/预测_annual_2025.json

  1.2 兼容性过渡方案

  // 双文件名兼容读取（至少保留1个版本周期）
  async function loadActualsAnnual2025() {
    // 优先级1: localStorage
    const local = lsGetJson(LS_KEYS.actualsAnnual2025);
    if (local) return ActualsAnnualFileSchema.parse(local);

    // 优先级2: 新命名文件
    try {
      return await fetchJson("/data/actuals_annual_2025.json", ActualsAnnualFileSchema);
    } catch {}

    // 优先级3: 旧命名兼容（过渡期）
    try {
      return await fetchJson("/data/预测_annual_2025.json", ActualsAnnualFileSchema);
    } catch {}

    // 优先级4: fallback空数据
    return { year: 2025, unit: "万元", type: "actuals_annual", records: [] };
  }

---

  二、计算引擎口径规范（一次定死）

  2.1 增长率与增量字段标准

  新建文件：src/domain/growth.ts

  /**

* 增长率与增量计算引擎
* 口径标准：严格按 metrics_definition.md 定义
  */

  export type GrowthMetrics = {
    // === 增长率（同比）===
    growth_month_rate: number | null;      // 当月同比增长率
    growth_quarter_rate: number | null;    // 当季同比增长率
    growth_ytd_rate: number | null;        // 年累计同比增长率

    // === 增量（绝对差值）===
    inc_month: number | null;              // 当月增量（万元）
    inc_quarter: number | null;            // 当季增量（万元）
    inc_ytd: number | null;                // 年累计增量（万元）

    // === 元数据 ===
    reason?: string;                       // null原因码（如 division_by_zero）
  };

  /**

* 计算增长指标（月/季/年三种口径）
* 分母为0时返回null，UI显示"—"
  */
  export function calculateGrowthMetrics(
  current: { month: number; quarter: number; ytd: number },
  baseline: { month: number; quarter: number; ytd: number }
  ): GrowthMetrics {
  const growth_month = safeDivide(current.month - baseline.month, baseline.month);
  const growth_quarter = safeDivide(current.quarter - baseline.quarter, baseline.quarter);
  const growth_ytd = safeDivide(current.ytd - baseline.ytd, baseline.ytd);

    return {
      growth_month_rate: growth_month.value,
      growth_quarter_rate: growth_quarter.value,
      growth_ytd_rate: growth_ytd.value,

    inc_month: current.month - baseline.month,
      inc_quarter: current.quarter - baseline.quarter,
      inc_ytd: current.ytd - baseline.ytd,

    reason: growth_month.reason || growth_quarter.reason || growth_ytd.reason,
    };
  }

  2.2 Null安全策略

- 分母为0：返回 null
- UI显示：null → "—"
- 原因码：reason: "division_by_zero" 或 "no_baseline_data"

---

  三、时间进度达成率双口径系统

  3.1 进度计算公式固化

  修改文件：src/domain/time.ts

  年度进度（已有，需确认公式注释）

  /**

* 年度线性进度 = m / 12
* @param month 当前月份（1-12）
  */
  export function linearProgressYear(month: number): number {
  return month / 12;
  }

  /**

* 年度权重进度 = sum(weights[0..month-1])
* @param weights 12个月权重数组，总和为1.0
* @param month 当前月份（1-12）
  */
  export function weightedProgressYear(weights: number[], month: number): number {
  return weights.slice(0, month).reduce((a, b) => a + b, 0);
  }

  季度进度（需新增）

  /**

* 季度线性进度 = (m - quarterStart + 1) / quarterMonths
* @param month 当前月份（1-12）
  */
  export function linearProgressQuarter(month: number): number {
  const q = Math.ceil(month / 3);
  const quarterStart = (q - 1) * 3 + 1;
  const monthInQuarter = month - quarterStart + 1;
  return monthInQuarter / 3;
  }

  /**

* 季度权重进度 = sum(weights[quarterStart..month]) / sum(weights[quarterStart..quarterEnd])
* @param weights 12个月权重数组
* @param month 当前月份（1-12）
  */
  export function weightedProgressQuarter(weights: number[], month: number): number {
  const q = Math.ceil(month / 3);
  const quarterStart = (q - 1) * 3;
  const quarterEnd = q * 3;

    const quarterWeights = weights.slice(quarterStart, quarterEnd);
    const currentWeights = weights.slice(quarterStart, month);

    const totalQuarterWeight = quarterWeights.reduce((a, b) => a + b, 0);
    const currentWeight = currentWeights.reduce((a, b) => a + b, 0);

    return currentWeight / totalQuarterWeight;
  }

  3.2 默认权重配置

  新建文件：src/config/progressWeights.ts

  /**

* 默认月度权重配置（可由用户在设置页调整）
* 总和 = 100% (1.0)
  */
  export const DEFAULT_MONTHLY_WEIGHTS = [
  0.070, // 1月 - 7.0%
  0.073, // 2月 - 7.3%
  0.092, // 3月 - 9.2%
  0.088, // 4月 - 8.8%
  0.094, // 5月 - 9.4%
  0.099, // 6月 - 9.9%
  0.066, // 7月 - 6.6%
  0.066, // 8月 - 6.6%
  0.068, // 9月 - 6.8%
  0.083, // 10月 - 8.3%
  0.083, // 11月 - 8.3%
  0.118, // 12月 - 11.8%
  ] as const;

  /**

* 默认季度权重配置（派生）
  */
  export const DEFAULT_QUARTERLY_WEIGHTS = {
  Q1: 0.27, // 27%（1-3月）
  Q2: 0.28, // 28%（4-6月）
  Q3: 0.20, // 20%（7-9月）
  Q4: 0.25, // 25%（10-12月）
  } as const;

  /**

* 验证权重数组总和是否为1（容差1e-6）
  */
  export function validateWeightsSum(weights: number[]): boolean {
  const sum = weights.reduce((a, b) => a + b, 0);
  return Math.abs(sum - 1.0) < 1e-6;
  }

  3.3 UI展示策略

  修改文件：src/app/page.tsx

  // 状态管理：用户可切换进度口径
  const [progressMode, setProgressMode] = useState<'linear' | 'weighted'>('weighted');

  // 计算双口径进度

---

  四、本次变更待办清单（主页面双 Y 轴）

- 更新 UI 开发指南：双 Y 轴图表口径与 3% 预警线说明
- 更新指标定义规范：增长率序列估算规则
- 实现主页面双 Y 轴图表：2026 目标、2025 实际、增长率右轴
- 增加增长率估算逻辑：缺 2026 分月实际时按线性/权重拆月
- 自测主页面展示：切换视角/产品/口径，确认增长率与预警线
  const timeProgress = {
    linear: {
      year: linearProgressYear(month),
      quarter: linearProgressQuarter(month),
    },
    weighted: {
      year: weightedProgressYear(weights, month),
      quarter: weightedProgressQuarter(weights, month),
    },
  };

  // UI显示：根据用户选择展示
  const currentProgress = timeProgress[progressMode];

  UI组件：进度口径切换器
  <select value={progressMode} onChange={(e) => setProgressMode(e.target.value)}>
    `<option value="weighted">`目标权重（推荐）`</option>`
    `<option value="linear">`线性月份`</option>`
  `</select>`

---

  四、机构维度一致性保障

  4.1 机构映射表核心化

  确认文件：src/config/organizationModes.ts（已存在）

  验证点：

- ✅ 同城7个：本部、天府、高新、新都、青羊、武侯、西财俊苑
- ✅ 异地7个：宜宾、泸州、德阳、资阳、乐山、自贡、达州
- ✅ 总计14个机构 = actuals_monthly_2025.json 中的机构数量

  4.2 机构ID一致性检查

  新增验证函数：src/domain/validate.ts

  /**

* 验证数据文件中的机构ID是否在标准映射表中
  */
  export function validateOrganizationIds(
  dataOrgIds: string[],
  standardOrgIds: string[]
  ): { valid: boolean; missing: string[]; extra: string[] } {
  const standard = new Set(standardOrgIds);
  const data = new Set(dataOrgIds);

    const missing = standardOrgIds.filter(id => !data.has(id));
    const extra = dataOrgIds.filter(id => !standard.has(id));

    return {
      valid: missing.length === 0 && extra.length === 0,
      missing,
      extra,
    };
  }

---

  五、容器与布局规范遵循

  5.1 大屏适配配置

  确认文件：docs/全局设计规范.md（已存在）

  关键约束：

- ✅ PPT容器宽度：2400px
- ✅ 内容区宽度：2100px（1.5倍扩展）
- ✅ KPI卡片布局：6列（适配宽屏）
- ✅ 图表高度：600px（标准）

  5.2 主页布局修改

  修改文件：src/app/page.tsx

  {/* KPI卡片：从4列改为6列 */}

<section className="grid grid-cols-1 gap-4 md:grid-cols-4 lg:grid-cols-6">
    <KpiCard title="年度目标" value={...} />
    <KpiCard title="YTD目标" value={...} />
    <KpiCard title="YTD实际" value={...} />
    <KpiCard title="年度达成率" value={...} />
    <KpiCard title="时间进度达成率" value={...} />
    <KpiCard title="年累计增长率" value={...} variant={growthVariant} />
  </section>

---

  📋 修订后的文件清单

  核心代码文件（按优先级排序）

| 序号 | 文件路径                             | 修改类型 | 关键内容                        |
| ---- | ------------------------------------ | -------- | ------------------------------- |
| 1    | src/services/loaders.ts              | 修改     | 统一优先级规则、双文件名兼容    |
| 2    | src/domain/growth.ts                 | 新建     | 6个增长率/增量字段、口径标准    |
| 3    | src/domain/time.ts                   | 扩展     | 季度进度计算函数                |
| 4    | src/config/progressWeights.ts        | 新建     | 默认权重配置                    |
| 5    | src/domain/validate.ts               | 新建     | 机构ID一致性验证                |
| 6    | src/app/page.tsx                     | 重构     | 增长率集成、双口径展示、6列布局 |
| 7    | src/services/storage.ts              | 扩展     | 新增LS_KEYS.actualsAnnual2025   |
| 8    | public/data/actuals_annual_2025.json | 重命名   | 从预测_annual_2025.json         |

  文档文件

| 序号 | 文件路径                   | 修改类型 | 关键内容                  |
| ---- | -------------------------- | -------- | ------------------------- |
| 9    | docs/architecture.md       | 补充     | 数据加载优先级规则        |
| 10   | docs/metrics_definition.md | 补充     | 6字段口径定义、双进度公式 |
| 11   | docs/全局设计规范.md       | 确认     | 容器布局、KPI列数规范     |
| 12   | 对话总结20251223.md        | 更新     | 本次补强点与实施记录      |

---

## 📝 待办清单（Task List）

> **说明**：按依赖关系和优先级排序，供后续 AI 接力开发使用

### 基础设施层（优先级：P0）

- [x] **任务1**: 扩展 `src/services/storage.ts`
  - **位置**：第5-8行附近
  - **内容**：在 `LS_KEYS` 对象中新增 `actualsAnnual2025: "tm:actuals_annual:2025"`
  - **验证**：确保常量导出正确

- [x] **任务2**: 修改 `src/services/loaders.ts` - loadActualsMonthly2025()
  - **位置**：第93-104行
  - **内容**：实现三级优先级加载
    1. localStorage (LS_KEYS.actualsMonthly2025)
    2. `/data/actuals_monthly_2025.json`
    3. fallback 空数据
  - **验证**：测试三种加载场景，确保优先级正确

- [x] **任务3**: 新建 `src/services/loaders.ts` - loadActualsAnnual2025()
  - **位置**：第105行后新增
  - **内容**：实现四级优先级加载（含双文件名兼容）
    1. localStorage (LS_KEYS.actualsAnnual2025)
    2. `/data/actuals_annual_2025.json`
    3. `/data/预测_annual_2025.json`（兼容旧名）
    4. fallback 空数据
  - **Schema**：使用 `ActualsAnnualFileSchema`
  - **验证**：测试四种加载场景，确保兼容性过渡

### 计算引擎层（优先级：P0）

- [x] **任务4**: 新建 `src/domain/growth.ts`
  - **内容**：
    1. 定义 `GrowthMetrics` 类型（6个字段）
    2. 实现 `calculateGrowthMetrics()` 函数
    3. 导入 `safeDivide` from `./achievement.ts`
  - **口径**：严格按 `docs/metrics_definition.md` 定义
  - **null安全**：分母为0返回 `null`，附带 `reason` 字段
  - **验证**：编写单元测试覆盖边界情况（待补）

- [x] **任务5**: 新建 `src/domain/validate.ts`
  - **内容**：实现 `validateOrganizationIds()` 函数
  - **功能**：验证数据机构ID与标准映射表一致性
  - **返回**：`{ valid, missing, extra }`
  - **验证**：测试14机构数据验证

- [x] **任务6**: 扩展 `src/domain/time.ts`
  - **位置**：文件末尾新增
  - **内容**：
    1. 新增 `linearProgressQuarter(month)` 函数
    2. 新增 `weightedProgressQuarter(weights, month)` 函数
  - **注释**：添加 JSDoc 注释说明公式
  - **验证**：测试各季度各月份的进度计算（待补）

### 配置层（优先级：P1）

- [x] **任务7**: 新建 `src/config/progressWeights.ts`
  - **内容**：
    1. 导出 `DEFAULT_MONTHLY_WEIGHTS`（12个月权重数组）
    2. 导出 `DEFAULT_QUARTERLY_WEIGHTS`（Q1-Q4权重对象）
    3. 导出 `validateWeightsSum()` 验证函数
  - **约束**：权重总和为 1.0，容差 1e-6
  - **验证**：确保月度权重之和 = 1.0

### 数据层（优先级：P1）

- [x] **任务8**: 重命名数据文件
  - **原路径**：`public/data/预测_annual_2025.json`
  - **新路径**：`public/data/actuals_annual_2025.json`
  - **操作**：使用 `mv` 或 `cp` 命令重命名
  - **验证**：确认新文件存在，旧文件可保留（兼容期）

### UI层（优先级：P0 - 核心功能）

- [x] **任务9**: 重构 `src/app/page.tsx` - 数据加载与计算
  - **位置**：第38-52行 useEffect 区域
  - **内容**：
    1. 新增 `loadActualsMonthly2025()` 加载调用
    2. 新增 state: `monthlyActuals2025`
    3. 聚合2025年YTD实际值（复用 aggregateToGroupAndAll）
    4. 计算增长率指标（调用 `calculateGrowthMetrics`）
  - **依赖**：任务2、任务4完成后进行
  - **验证**：console.log 验证数据加载和计算结果

- [x] **任务10**: 修改 `src/app/page.tsx` - UI布局与展示
  - **位置**：第202-215行 KPI卡片区域
  - **内容**：
    1. 修改 grid 布局：`md:grid-cols-4` → `md:grid-cols-4 lg:grid-cols-6`
    2. 新增第6个 KpiCard：年累计增长率
    3. 根据增长率正负设置 variant（正→good，负→danger）
    4. null 值显示为 "—"
  - **样式**：遵循 `docs/全局设计规范.md` 布局约束
  - **验证**：浏览器查看6列布局效果

### 文档层（优先级：P2）

- [x] **任务11**: 补充 `docs/architecture.md`
  - **位置**：第8-18行"分层"章节后
  - **内容**：新增"数据加载优先级规则"章节
  - **内容要点**：
    - localStorage > public/data > fallback
    - 双文件名兼容策略
    - 用户输入优先原则
  - **验证**：确保与实际 loaders.ts 实现一致

- [x] **任务12**: 补充 `docs/metrics_definition.md`
  - **位置**：第38-48行"同比增长与增量"章节
  - **内容**：
    1. 明确6字段口径定义（growth_month_rate, inc_month 等）
    2. 补充双进度公式（线性/权重，年度/季度）
    3. 添加计算示例
  - **验证**：确保与 growth.ts 和 time.ts 实现一致

---

## 🔄 任务依赖关系图

```
任务1 (storage.ts)
  ↓
任务2、任务3 (loaders.ts) ← 任务8 (重命名文件)
  ↓
任务4 (growth.ts) ← 任务6 (time.ts) ← 任务7 (progressWeights.ts)
  ↓
任务9 (page.tsx 数据加载)
  ↓
任务10 (page.tsx UI展示)
  ↓
任务11、任务12 (文档补充)

任务5 (validate.ts) - 独立任务，可并行开发
```

---

## ✅ 验收标准

### 功能验收
1. 主页能正确加载2025分月数据（优先从localStorage，再从public/data）
2. 增长率和增量指标计算正确（当月、当季、年累计）
3. 双口径时间进度达成率切换正常
4. 分母为0时显示"—"而非报错
5. KPI卡片6列布局在大屏显示正常

### 代码质量验收
1. 所有新增函数有 JSDoc 注释
2. 所有计算函数有单元测试（growth.ts, time.ts）
3. TypeScript 类型定义完整，无 any 类型
4. 遵循项目现有代码风格（domain/纯函数，services/副作用）

### 文档验收
1. 实施规划文档完整记录所有变更
2. architecture.md 和 metrics_definition.md 更新到位
3. 代码注释与文档口径一致

---

## 📌 关键注意事项

1. **优先级规则固化**：所有 loader 必须严格遵循 localStorage > public/data > fallback
2. **双文件名兼容**：至少保留1个版本周期，防止线上数据断裂
3. **口径一次定死**：增长率6字段、双进度公式，定义后不可随意改动
4. **null安全**：所有除法运算使用 `safeDivide()`，UI层统一处理 null → "—"
5. **机构ID一致性**：确保14机构与 organizationModes.ts 映射表完全一致
6. **布局规范**：KPI卡片6列、内容区2100px、图表600px，严格遵循设计规范

---

**最后更新**：2025-12-23
**AI接力说明**：按任务1-12顺序执行，遇到阻塞可参考依赖关系图调整顺序
